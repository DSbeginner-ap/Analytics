{
	"name": "UpdateCustomerDimension_SCD_2",
	"properties": {
		"description": "Import Data From Customer Source.",
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "CustomerSourceADLS",
						"type": "DatasetReference"
					},
					"name": "SourceDB"
				},
				{
					"dataset": {
						"referenceName": "DimCustomer_2",
						"type": "DatasetReference"
					},
					"name": "DimCustomer"
				}
			],
			"sinks": [],
			"transformations": [
				{
					"name": "AddHashInputs"
				},
				{
					"name": "RenameSourceColumns"
				},
				{
					"name": "FilterForActive"
				},
				{
					"name": "AddHashExisting"
				},
				{
					"name": "AddCustomerKey"
				},
				{
					"name": "JoinWithMaxSurrogatekey"
				},
				{
					"name": "GetMaxSurrogateKey"
				},
				{
					"name": "AddDimensionColumns"
				},
				{
					"name": "DropUnwantedColumns"
				},
				{
					"name": "MarkAsInsert"
				}
			],
			"script": "parameters{\n\tPrimaryKey as string ('src_CustomerID'),\n\tColumns as string ('src_FirstName,src_MiddleName,src_LastName')\n}\nsource(output(\n\t\tCustomerID as integer,\n\t\tTitle as string,\n\t\tFirstName as string,\n\t\tMiddleName as string,\n\t\tLastName as string,\n\t\tSuffix as string,\n\t\tCompanyName as string,\n\t\tSalesPerson as string,\n\t\tEmailAddress as string,\n\t\tPhone as string\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tignoreNoFilesFound: false) ~> SourceDB\nsource(output(\n\t\tCustomerKey as integer,\n\t\tCustomerID as integer,\n\t\tTitle as string,\n\t\tFirstName as string,\n\t\tMiddleName as string,\n\t\tLastName as string,\n\t\tSuffix as string,\n\t\tCompanyName as string,\n\t\tSalesPerson as string,\n\t\tEmailAddress as string,\n\t\tPhone as string,\n\t\tStartDate as timestamp,\n\t\tEndDate as date,\n\t\tModifiedDate as date,\n\t\tIsCurrent as integer\n\t),\n\tallowSchemaDrift: true,\n\tvalidateSchema: false,\n\tisolationLevel: 'READ_UNCOMMITTED',\n\tformat: 'table',\n\tstaged: false) ~> DimCustomer\nRenameSourceColumns derive(Id_Hash = md5(byName($PrimaryKey)),\n\t\tColumns_Hash = md5(byNames(split($Columns, ',')))) ~> AddHashInputs\nSourceDB select(mapColumn(\n\t\tsrc_CustomerID = CustomerID,\n\t\tsrc_Title = Title,\n\t\tsrc_FirstName = FirstName,\n\t\tsrc_MiddleName = MiddleName,\n\t\tsrc_LastName = LastName,\n\t\tsrc_Suffix = Suffix,\n\t\tsrc_CompanyName = CompanyName,\n\t\tsrc_SalesPerson = SalesPerson,\n\t\tsrc_EmailAddress = EmailAddress,\n\t\tsrc_Phone = Phone\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> RenameSourceColumns\nDimCustomer filter(toInteger(byName('IsCurrent')) == 1) ~> FilterForActive\nFilterForActive derive(Id_Hash = md5(byNames(split($PrimaryKey, ','))),\n\t\tColumns_Hash = md5(byNames(split($Columns, ',')))) ~> AddHashExisting\nAddHashInputs keyGenerate(output(CustomerKey as long),\n\tstartAt: 1L) ~> AddCustomerKey\nAddCustomerKey, GetMaxSurrogateKey join(CustomerKey == MaxSurrogateKey || true(),\n\tjoinType:'cross',\n\tbroadcast: 'auto')~> JoinWithMaxSurrogatekey\nAddHashExisting aggregate(MaxSurrogateKey = max(toInteger(byName('CustomerKey')))) ~> GetMaxSurrogateKey\nJoinWithMaxSurrogatekey derive(CustomerKey = CustomerKey + MaxSurrogateKey,\n\t\tIsCurrent = 1,\n\t\tStartDate = currentUTC(),\n\t\tEndDate = toTimestamp(toString(null()))) ~> AddDimensionColumns\nAddDimensionColumns select(mapColumn(\n\t\tsrc_CustomerID,\n\t\tsrc_Title,\n\t\tsrc_FirstName,\n\t\tsrc_MiddleName,\n\t\tsrc_LastName,\n\t\tsrc_Suffix,\n\t\tsrc_CompanyName,\n\t\tsrc_SalesPerson,\n\t\tsrc_EmailAddress,\n\t\tsrc_Phone,\n\t\tIsCurrent,\n\t\tStartDate,\n\t\tEndDate,\n\t\tCustomerKey\n\t),\n\tskipDuplicateMapInputs: true,\n\tskipDuplicateMapOutputs: true) ~> DropUnwantedColumns\nDropUnwantedColumns alterRow(insertIf(true())) ~> MarkAsInsert"
		}
	}
}